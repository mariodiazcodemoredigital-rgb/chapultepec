@page "/crmadmin"
@using Microsoft.EntityFrameworkCore
@using crmchapultepec.data.Data
@using crmchapultepec.services.Interfaces.EvolutionWebhook

@inject IWebhookControlService Toggle
@inject IDbContextFactory<CrmInboxDbContext> Factory
@inject IJSRuntime JS

@rendermode InteractiveServer
<h3>Webhook Evolution</h3>

<label>
    <input type="checkbox" @bind="_enabled" />
    @(_enabled ? "ENCENDIDO" : "APAGADO")
</label>

<button class="btn btn-primary" @onclick="@(() => Save())">Guardar</button>

@code {
    bool _enabled;

    protected override async Task OnInitializedAsync()
    {
        _enabled = await Toggle.IsEvolutionEnabledAsync();
    }

    private async Task Save()
    {
        await using var db = await Factory.CreateDbContextAsync();
        var row = await db.WebhookControls.SingleAsync(x => x.Name == "EvolutionWebhook");
        row.Enabled = _enabled;
        row.UpdatedUtc = DateTime.UtcNow;
        await db.SaveChangesAsync();
    }
}
