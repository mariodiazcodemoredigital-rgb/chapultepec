@using crmchapultepec.entities.Entities.CRM
@using crmchapultepec.entities.EvolutionWebhook
@using crmchapultepec.services.Implementation.CRM

@* Inyectamos el servicio para poder guardar los cambios del contacto *@
@inject CRMxEquiposService Equipos
@inject CRMxUsuariosService Usuarios
@inject CRMxEquiposUsuariosService Rel

@inject CRMInboxService Inbox
@inject IJSRuntime JS

@if (Thread is null)
{
    <div class="crm-inbox__chat">
        <div class="crm-inbox__chat-body"><div class="crm-inbox__meta">Selecciona una conversación</div></div>
        <div class="crm-inbox__chat-input">
            <textarea class="crm-inbox__textarea" disabled placeholder="Escribe un mensaje..."></textarea>
            <button class="crm-inbox__btn" disabled>Enviar</button>
        </div>
    </div>
}
else
{
    <div class="crm-inbox__chat">
        <div class="crm-inbox__chat-header">
            @if (ShowBackButton)
            {
                <button class="crm-inbox__back" @onclick="OnBack" title="Volver">←</button>
            }

            <div class="crm-inbox__header-left clickwrap" role="button" @onclick="OpenContactModal">
                <div class="crm-inbox__avatar">@AvatarInitial</div>

                <div class="crm-inbox__nameblock">
                    <div class="crm-inbox__name">@Thread.CustomerDisplayName</div>
                    <div class="crm-inbox__meta">@GetChannelString(Thread.Channel) · @Thread.CustomerPhone</div>
                </div>
            </div>

            <div class="crm-inbox__spacer"></div>

            <div class="crm-inbox__header-right">
                @if (!string.IsNullOrWhiteSpace(Thread.AssignedTo))
                {
                    <div class="crm-inbox__assignee">
                        <i class="fas fa-user-circle"></i>&nbsp;
                        @if (int.TryParse(Thread.AssignedTo, out var uid) && !userCache.ContainsKey(uid))
                        {
                            <span class="loading-text">Cargando...</span> @* Aquí no se ve el ID *@
                        }
                        else
                        {
                            @ResolveAssigneeName(Thread.AssignedTo)
                        }
                    </div>
                }

                <button class="btn btn--reassign" @onclick="OpenAssignModal">
                    @(string.IsNullOrWhiteSpace(Thread.AssignedTo) ? "Asignar" : "Reasignar")
                </button>
            </div>
        </div>

        <div id="chat-container" class="crm-inbox__chat-body">
            @foreach (var m in Thread.Messages.OrderBy(m => m.TimestampUtc))
            {
                var isMine = !m.DirectionIn;
                var rowClass = isMine ? "crm-inbox__msg-row crm-inbox__msg-row--right" : "crm-inbox__msg-row";
                @* var bubbleClass = isMine ? "crm-inbox__bubble crm-inbox__bubble--out" : "crm-inbox__bubble crm-inbox__bubble--in"; *@

                // Si es sticker, quitamos la clase de la burbuja para que no tenga fondo/borde
                var isSticker = (MessageKind)m.MessageKind == MessageKind.Sticker;

                var bubbleClass = isSticker
                ? (isMine ? "crm-inbox__bubble--sticker-out" : "crm-inbox__bubble--sticker-in")
                : (isMine ? "crm-inbox__bubble crm-inbox__bubble--out" : "crm-inbox__bubble crm-inbox__bubble--in");

                
                

                <div class="@rowClass">
                    @if (!isMine)
                    {
                        <div class="crm-inbox__avatar" style="width:28px;height:28px;">
                            @AvatarInitial
                        </div>
                    }
                    <div class="msg">
                        <div class="@bubbleClass" style="position: relative;">
                            @* 1. Prioridad: Medias Desencriptados por ID (Stickers e Imágenes locales) *@
                            @if (isSticker)
                            {
                                <img src="/api/webhook/evolution/view-sticker/@m.Id"
                                     style="width: 150px; height: 150px; object-fit: contain; pointer-events: none;"
                                     alt="Sticker" />
                            }
                            else if ((MessageKind)m.MessageKind == MessageKind.Image && m.Id > 0)
                            {
                                <img src="/api/webhook/evolution/download/@m.Id" class="msg-thumb" loading="lazy" />
                            }
                            @* 2. Fallback: Medias por URL directa (Solo si no es sticker/imagen ya procesada) *@
                            else if (!string.IsNullOrWhiteSpace(m.MediaUrl))
                            {
                                <div class="msg-media">
                                    @if (IsImage(m.MediaMime))
                                    {
                                        <a href="@m.MediaUrl" target="_blank">
                                            <img src="@m.MediaUrl" class="msg-thumb" loading="lazy" />
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="@m.MediaUrl" target="_blank" class="msg-attach-chip">
                                            <span class="msg-attach-icon">📎</span>
                                            <span class="msg-attach-name">Archivo Adjunto</span>
                                        </a>
                                    }
                                </div>
                            }

                            @* 3. Texto del mensaje *@
                            @if (!string.IsNullOrWhiteSpace(m.Text))
                            {
                                <div class="msg-text">@m.Text</div>
                            }

                            @if (!string.IsNullOrEmpty(m.Reaction))
                            {
                                <div class="msg-reaction-badge">
                                    @m.Reaction
                                </div>
                            }
                        </div>

                        <div class="crm-inbox__meta">
                            @m.TimestampUtc.ToLocalTime().ToString("dd MMM HH:mm")
                            @if (isMine && !string.IsNullOrWhiteSpace(m.Sender))
                            {
                                <span>· @m.Sender</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="crm-inbox__chat-input">
            <textarea class="crm-inbox__textarea"
                      placeholder="Escribe un mensaje…"
                      @bind="Draft"
                      @bind:event="oninput">
                    </textarea>
            <button class="crm-inbox__btn crm-inbox__btn--primary" @onclick="Send" disabled="@string.IsNullOrWhiteSpace(Draft)">Enviar</button>
        </div>
    </div>
}
@if (showAssignModal)
{
    <div class="overlay">
        <div class="modal">
            <div class="modal__header">
                <div class="modal__title">Asignar Agente</div>
                <button class="btn btn-ghost" @onclick="CloseAssignModal">✕</button>
            </div>

            <div class="modal__body">
                @if (cargando)
                {
                    <div class="muted">Cargando equipos...</div>
                }
                else
                {
                    @foreach (var equipo in equiposVm)
                    {
                        <div class="modal__group" style="margin-bottom: 1rem;">
                            <div class="modal__group-title" style="font-weight: bold; color: var(--brand-color);">
                                📁 @equipo.Nombre
                            </div>
                            @foreach (var miembro in equipo.Miembros)
                            {
                                <label class="radio-row" style="display: block; padding: 5px; cursor: pointer;">
                                    <input type="radio" name="agente"
                                           checked="@(selectedUsuarioId == miembro.UsuarioId)"
                                           @onchange="() => SelectUsuario(miembro.UsuarioId)" />
                                    <span>@miembro.UserName <small class="muted">(@miembro.Telefono)</small></span>
                                </label>
                            }
                        </div>
                    }
                }
            </div>

            <div class="modal__footer">
                @* Nuevo botón para quitar asignación *@
                @if (!string.IsNullOrWhiteSpace(Thread.AssignedTo))
                {
                    <button class="btn btn--danger-outline" @onclick="Unassign" style="margin-right: auto;">
                        Quitar asignación
                    </button>
                }
                <button class="btn btn--secondary" @onclick="CloseAssignModal">Cancelar</button>
                <button class="btn btn--primary" @onclick="ConfirmAssign"
                        disabled="@(selectedUsuarioId == null)">
                    Confirmar Asignación
                </button>
            </div>
        </div>
    </div>
}

@if (showContactModal)
{
    <div class="overlay">
        <div class="modal modal--contact">
            <div class="modal__header">
                <div class="modal__title">Editar Contacto</div>
                <button class="btn btn-ghost" @onclick="CloseContactModal">✕</button>
            </div>
            <div class="modal__body">
                <div class="form-row">
                    <label>Nombre</label>
                    <input class="input-pro" @bind="contactName" />
                </div>
                <div class="form-row">
                    <label>Teléfono</label>
                    <input class="input-pro" @bind="contactPhone" />
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input class="input-pro" @bind="contactEmail" />
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn-brand" @onclick="SaveContact">Guardar</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public CrmThread? Thread { get; set; }
    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback OnAssignToMe { get; set; }
    [Parameter] public bool ShowBackButton { get; set; } = false;
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public string? CurrentUser { get; set; }
    [Parameter] public EventCallback OnAssignUpdated { get; set; }

    public record ContactChangedArgs(string ThreadId, string Name, string? Phone, string? Email, string? Company);
    [Parameter] public EventCallback<ContactChangedArgs> OnContactUpdated { get; set; }

    private string Draft { get; set; } = "";
    private string AvatarInitial => string.IsNullOrWhiteSpace(Thread?.CustomerDisplayName) ? "?" : Thread.CustomerDisplayName.Trim()[0].ToString().ToUpper();

    private bool showContactModal;
    private string contactName = "";
    private string contactPhone = "";
    private string contactEmail = "";

    private bool _shouldScroll = false;

    // ViewModels internos
    private class EquipoVM
    {
        public int EquipoId { get; set; }
        public string Nombre { get; set; } = "";
        public List<MiembroVM> Miembros { get; set; } = new();
    }
    private class MiembroVM
    {
        public int UsuarioId { get; set; }
        public string UserName { get; set; } = "";
        public string Telefono { get; set; } = "";
        public bool Activo { get; set; }
    }

    // --- Modal Asignación ---
    private bool showAssignModal;
    private bool cargando;
    private int? selectedUsuarioId;

    private readonly List<EquipoVM> equiposVm = new();
    private readonly Dictionary<int, CRMUsuario> userCache = new();

    // Detecta cuando cambia el hilo de conversación
    protected override async Task OnParametersSetAsync()
    {
        _shouldScroll = true;

        if (Thread != null && !string.IsNullOrWhiteSpace(Thread.AssignedTo))
        {
            if (int.TryParse(Thread.AssignedTo, out var uid))
            {
                // Solo consultamos la DB si el usuario NO está ya en el cache
                if (!userCache.ContainsKey(uid))
                {
                    // Llamamos a tu servicio GetAsync(int id)
                    var user = await Usuarios.GetAsync(uid);

                    if (user != null)
                    {
                        // Lo guardamos en el cache para no volver a consultar mientras
                        // el componente esté vivo
                        userCache[uid] = user;

                        // Notificamos a Blazor que el nombre ya llegó y debe refrescar la UI
                        StateHasChanged();
                    }
                }
            }
        }
    }

    // Ejecuta el scroll después de que el HTML se ha renderizado
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_shouldScroll)
        {
            _shouldScroll = false;
            await Task.Delay(150); // Tiempo para que carguen imágenes/stickers
            await JS.InvokeVoidAsync("scrollToBottom", "chat-container");
        }
    }


    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(Draft)) return;
        await OnSend.InvokeAsync(Draft);
        Draft = "";
    }

    private string GetChannelString(int ch) => ch switch { 1 => "WhatsApp", 2 => "Messenger", 3 => "IG", _ => "Otro" };
    private bool IsImage(string? mime) => mime != null && mime.StartsWith("image/", StringComparison.OrdinalIgnoreCase);

    private void OpenContactModal()
    {
        if (Thread is null) return;
        contactName = Thread.CustomerDisplayName ?? "";
        contactPhone = Thread.CustomerPhone ?? "";
        contactEmail = Thread.CustomerEmail ?? "";
        showContactModal = true;
    }

    private void CloseContactModal() => showContactModal = false;

    private async Task SaveContact()
    {
        if (Thread is null) return;

        // DESCOMENTADO Y CORREGIDO:
        await Inbox.UpsertContactAsync(
            channel: Thread.Channel,
            businessAccountId: Thread.BusinessAccountId ?? "default",
            displayName: contactName,
            email: contactEmail,
            company: Thread.CompanyId,
            phone: contactPhone,
            platformId: Thread.CustomerPlatformId
        );

        await OnContactUpdated.InvokeAsync(new ContactChangedArgs(Thread.ThreadId, contactName, contactPhone, contactEmail, Thread.CompanyId));

        CloseContactModal();
    }

    private async Task OpenAssignModal()
    {
        if (Thread is null) return;

        showAssignModal = true;
        cargando = true;
        equiposVm.Clear();

        // 1. Cargar datos maestros
        var todosLosEquipos = await Equipos.GetAllAsync();
        var todosLosUsuarios = await Usuarios.GetAllAsync();

        // Llenar cache de usuarios para acceso rápido
        userCache.Clear();
        foreach (var u in todosLosUsuarios) userCache[u.UsuarioId] = u;

        // 2. Filtrar equipos activos y armar el árbol
        var equiposActivos = todosLosEquipos.Where(e => e.Activo).OrderBy(e => e.Nombre);

        foreach (var eq in equiposActivos)
        {
            // Obtener relaciones de este equipo
            var relaciones = await Rel.GetByEquipoAsync(eq.EquipoId);

            var vm = new EquipoVM
            {
                EquipoId = eq.EquipoId,
                Nombre = eq.Nombre,
                Miembros = relaciones
                    .Where(r => r.Activo) // Solo miembros activos en el equipo
                    .Select(r => new MiembroVM
                    {
                        UsuarioId = r.UsuarioId,
                        UserName = userCache.TryGetValue(r.UsuarioId, out var u) ? u.UserName : $"ID {r.UsuarioId}",
                        Telefono = userCache.TryGetValue(r.UsuarioId, out var u2) ? u2.Telefono ?? "" : ""
                    })
                    .OrderBy(m => m.UserName)
                    .ToList()
            };

            if (vm.Miembros.Any()) equiposVm.Add(vm);
        }

        // 3. Preseleccionar si ya hay alguien asignado
        selectedUsuarioId = null;
        if (int.TryParse(Thread.AssignedTo, out var currentId))
            selectedUsuarioId = currentId;

        cargando = false;
        StateHasChanged();
    }

    private void CloseAssignModal() => showAssignModal = false;
    private void SelectUsuario(int id) => selectedUsuarioId = id;

    private async Task ConfirmAssign()
    {
        if (Thread is null || !selectedUsuarioId.HasValue) return;

        // Guardar asignación (Asegúrate que Inbox.AssignAsync acepte estos params)
        await Inbox.AssignAsync(Thread.ThreadId, selectedUsuarioId.Value.ToString());

        // Actualizar UI localmente
        Thread.AssignedTo = selectedUsuarioId.Value.ToString();

        showAssignModal = false;

        // Avisar al componente padre para que notifique a SignalR
        await OnAssignUpdated.InvokeAsync();

        StateHasChanged();
    }

    private async Task Unassign()
    {
        if (Thread is null) return;

        try
        {
            // 1. Llamamos al servicio pasando null para limpiar la columna AssignedTo
            await Inbox.AssignAsync(Thread.ThreadId, null);

            // 2. Actualizamos el estado local del hilo
            Thread.AssignedTo = null;

            // 3. Opcional: Si tienes una lista de hilos en memoria en este componente
            // o quieres que se refresque el nombre, puedes limpiar la selección.
            selectedUsuarioId = null;

            CloseAssignModal();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al quitar la asignación: {ex.Message}");
        }
    }

    private string ResolveAssigneeName(string? assigned)
    {
        if (string.IsNullOrWhiteSpace(assigned)) return "Sin asignar";

        // Si el valor es un número, buscamos en el cache
        if (int.TryParse(assigned, out var uid))
        {
            if (userCache.TryGetValue(uid, out var user))
            {
                return user.UserName; // Devolvemos el nombre real
            }

            // Si no está en cache (porque no hemos abierto el modal),
            // podrías dejarlo así o disparar una carga rápida.
            return $" {uid}";
        }

        return assigned; // Si era un texto (como "Sistema"), lo devuelve tal cual
    }
}