@using crmchapultepec.entities.Entities.CRM
@using crmchapultepec.entities.EvolutionWebhook
@using crmchapultepec.services.Implementation.CRM

@* 👇 Inyectamos el servicio para poder guardar los cambios del contacto *@
@inject CRMInboxService Inbox

@if (Thread is null)
{
    <div class="crm-inbox__chat">
        <div class="crm-inbox__chat-body"><div class="crm-inbox__meta">Selecciona una conversación</div></div>
        <div class="crm-inbox__chat-input">
            <textarea class="crm-inbox__textarea" disabled placeholder="Escribe un mensaje..."></textarea>
            <button class="crm-inbox__btn" disabled>Enviar</button>
        </div>
    </div>
}
else
{
    <div class="crm-inbox__chat">
        <div class="crm-inbox__chat-header">
            @if (ShowBackButton)
            {
                <button class="crm-inbox__back" @onclick="OnBack" title="Volver">←</button>
            }

            <div class="crm-inbox__header-left clickwrap" role="button" @onclick="OpenContactModal">
                <div class="crm-inbox__avatar">@AvatarInitial</div>

                <div class="crm-inbox__nameblock">
                    <div class="crm-inbox__name">@Thread.CustomerDisplayName</div>
                    <div class="crm-inbox__meta">@GetChannelString(Thread.Channel) · @Thread.CustomerPhone</div>
                </div>
            </div>

            <div class="crm-inbox__spacer"></div>

            <div class="crm-inbox__header-right">
                @if (!string.IsNullOrWhiteSpace(Thread.AssignedTo))
                {
                    <div class="crm-inbox__assignee">
                        <i class="fas fa-user-circle"></i> @Thread.AssignedTo
                    </div>
                }

                <button class="btn btn--reassign" @onclick="OnAssignToMe">
                    @(string.IsNullOrWhiteSpace(Thread.AssignedTo) ? "Asignar a mí" : "Reasignar")
                </button>
            </div>
        </div>

        <div class="crm-inbox__chat-body">
            @foreach (var m in Thread.Messages.OrderBy(m => m.TimestampUtc))
            {
                var isMine = !m.DirectionIn;
                var rowClass = isMine ? "crm-inbox__msg-row crm-inbox__msg-row--right" : "crm-inbox__msg-row";
                var bubbleClass = isMine ? "crm-inbox__bubble crm-inbox__bubble--out" : "crm-inbox__bubble crm-inbox__bubble--in";
                // Si es sticker, quitamos la clase de la burbuja para que no tenga fondo/borde
                var isSticker = (MessageKind)m.MessageKind == MessageKind.Sticker;

                <div class="@rowClass">
                    @if (!isMine)
                    {
                        <div class="crm-inbox__avatar" style="width:28px;height:28px;">
                            @AvatarInitial
                        </div>
                    }
                    <div class="msg">
                        <div class="@bubbleClass" style="position: relative;">
                            @* 1. Prioridad: Medias Desencriptados por ID (Stickers e Imágenes locales) *@
                            @if (isSticker)
                            {
                                <img src="/api/webhook/evolution/view-sticker/@m.Id"
                                     style="width: 150px; height: 150px; object-fit: contain; pointer-events: none;"
                                     alt="Sticker" />
                            }
                            else if ((MessageKind)m.MessageKind == MessageKind.Image && m.Id > 0)
                            {
                                <img src="/api/webhook/evolution/download/@m.Id" class="msg-thumb" loading="lazy" />
                            }
                            @* 2. Fallback: Medias por URL directa (Solo si no es sticker/imagen ya procesada) *@
                            else if (!string.IsNullOrWhiteSpace(m.MediaUrl))
                            {
                                <div class="msg-media">
                                    @if (IsImage(m.MediaMime))
                                    {
                                        <a href="@m.MediaUrl" target="_blank">
                                            <img src="@m.MediaUrl" class="msg-thumb" loading="lazy" />
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="@m.MediaUrl" target="_blank" class="msg-attach-chip">
                                            <span class="msg-attach-icon">📎</span>
                                            <span class="msg-attach-name">Archivo Adjunto</span>
                                        </a>
                                    }
                                </div>
                            }

                            @* 3. Texto del mensaje *@
                            @if (!string.IsNullOrWhiteSpace(m.Text))
                            {
                               @m.Text
                            }

                            @if (!string.IsNullOrEmpty(m.Reaction))
                            {
                                <div class="msg-reaction-badge">
                                    @m.Reaction
                                </div>
                            }
                        </div>

                        <div class="crm-inbox__meta">
                            @m.TimestampUtc.ToLocalTime().ToString("dd MMM HH:mm")
                            @if (isMine && !string.IsNullOrWhiteSpace(m.Sender))
                            {
                                <span>· @m.Sender</span>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="crm-inbox__chat-input">
            <textarea class="crm-inbox__textarea"
                      placeholder="Escribe un mensaje…"
                      @bind="Draft"
                      @bind:event="oninput">
                    </textarea>
            <button class="crm-inbox__btn crm-inbox__btn--primary" @onclick="Send" disabled="@string.IsNullOrWhiteSpace(Draft)">Enviar</button>
        </div>
    </div>
}

@if (showContactModal)
{
    <div class="overlay">
        <div class="modal modal--contact">
            <div class="modal__header">
                <div class="modal__title">Editar Contacto</div>
                <button class="btn btn-ghost" @onclick="CloseContactModal">✕</button>
            </div>
            <div class="modal__body">
                <div class="form-row">
                    <label>Nombre</label>
                    <input class="input-pro" @bind="contactName" />
                </div>
                <div class="form-row">
                    <label>Teléfono</label>
                    <input class="input-pro" @bind="contactPhone" />
                </div>
                <div class="form-row">
                    <label>Email</label>
                    <input class="input-pro" @bind="contactEmail" />
                </div>
            </div>
            <div class="modal__footer">
                <button class="btn btn-brand" @onclick="SaveContact">Guardar</button>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public CrmThread? Thread { get; set; }
    [Parameter] public EventCallback<string> OnSend { get; set; }
    [Parameter] public EventCallback OnAssignToMe { get; set; }
    [Parameter] public bool ShowBackButton { get; set; } = false;
    [Parameter] public EventCallback OnBack { get; set; }
    [Parameter] public string? CurrentUser { get; set; }

    public record ContactChangedArgs(string ThreadId, string Name, string? Phone, string? Email, string? Company);
    [Parameter] public EventCallback<ContactChangedArgs> OnContactUpdated { get; set; }

    private string Draft { get; set; } = "";
    private string AvatarInitial => string.IsNullOrWhiteSpace(Thread?.CustomerDisplayName) ? "?" : Thread.CustomerDisplayName.Trim()[0].ToString().ToUpper();

    private bool showContactModal;
    private string contactName = "";
    private string contactPhone = "";
    private string contactEmail = "";

    private async Task Send()
    {
        if (string.IsNullOrWhiteSpace(Draft)) return;
        await OnSend.InvokeAsync(Draft);
        Draft = "";
    }

    private string GetChannelString(int ch) => ch switch { 1 => "WhatsApp", 2 => "Messenger", 3 => "IG", _ => "Otro" };
    private bool IsImage(string? mime) => mime != null && mime.StartsWith("image/", StringComparison.OrdinalIgnoreCase);

    private void OpenContactModal()
    {
        if (Thread is null) return;
        contactName = Thread.CustomerDisplayName ?? "";
        contactPhone = Thread.CustomerPhone ?? "";
        contactEmail = Thread.CustomerEmail ?? "";
        showContactModal = true;
    }

    private void CloseContactModal() => showContactModal = false;

    private async Task SaveContact()
    {
        if (Thread is null) return;

        // DESCOMENTADO Y CORREGIDO:
        await Inbox.UpsertContactAsync(
            channel: Thread.Channel,
            businessAccountId: Thread.BusinessAccountId ?? "default",
            displayName: contactName,
            email: contactEmail,
            company: Thread.CompanyId,
            phone: contactPhone,
            platformId: Thread.CustomerPlatformId
        );

        await OnContactUpdated.InvokeAsync(new ContactChangedArgs(Thread.ThreadId, contactName, contactPhone, contactEmail, Thread.CompanyId));

        CloseContactModal();
    }
}