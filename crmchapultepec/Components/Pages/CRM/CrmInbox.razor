@page "/crminbox"
@using Microsoft.AspNetCore.SignalR.Client
@using crmchapultepec.data.Repositories.CRM
@using crmchapultepec.entities.EvolutionWebhook
@using crmchapultepec.entities.Entities.CRM
@using crmchapultepec.services.Implementation.CRM

@inject CRMInboxService Inbox
@inject NavigationManager Nav
@implements IAsyncDisposable

@rendermode InteractiveServer

<input id="ls-toggle" type="checkbox" class="ls-toggle" hidden />

<div class="@ContainerClass">

  

    <div class="crm-inbox__panel crm-inbox__panel--visible crm-inbox__panel--col1 crm-inbox__sidebar">
        <InboxSidebar Selected="@Selected" OnSelect="ChangeFilter" NewConversation="NewConversation" />
    </div>

    <div class="crm-inbox__panel crm-inbox__panel--headered crm-inbox__panel--visible crm-inbox__panel--col2">
        @if (_loading)
        {
            <div class="crm-inbox__loading">Cargando conversaciones…</div>
        }
        else
        {
            <ThreadList Threads="@Threads" SelectedId="@SelectedThreadId" Selected="@Selected"
                        OnSelect="SelectThread" OnSearchChanged="SearchChanged" OnFilterChange="ChangeFilter" />
        }
    </div>

    <div class="crm-inbox__panel crm-inbox__panel--visible crm-inbox__panel--col3">
        @if (_loadingChat)
        {
            <div class="crm-inbox__loading">Cargando chat…</div>
        }
        else
        {
            <ChatView Thread="@SelectedThread" OnSend="SendMessage" OnAssignToMe="AssignToMe"
                      ShowBackButton="true" OnBack="BackToList" CurrentUser="@CurrentUser"
                      OnContactUpdated="HandleContactUpdated" />
        }
    </div>
</div>

@code {
    private InboxFilter Selected = InboxFilter.Todos;
    private string? SelectedThreadId;
    private string? SearchText;

    private IReadOnlyList<CrmThread> Threads = Array.Empty<CrmThread>();
    private CrmThread? SelectedThread;

    private bool _loading;
    private bool _loadingChat;

    private bool _mobileShowChat = false;
    private string ContainerClass => $"crm-inbox {(_mobileShowChat ? "crm-inbox--mobile-chat" : "crm-inbox--mobile-list")}";

    private const string CurrentUser = "you";
    private HubConnection? hubConnection;

  

    protected override async Task OnInitializedAsync()
    {
        // 1. Suscribirse al evento de cambios
        Inbox.Changed += OnInboxChanged;

        // 2. Cargar datos iniciales
        await LoadThreadsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                hubConnection = new HubConnectionBuilder()
                    .WithUrl(Nav.ToAbsoluteUri("/crmHub"))
                    .WithAutomaticReconnect()
                    .Build();

                hubConnection.On<dynamic>("NewMessage", async (data) =>
                {
                    // Para depurar: verás el aviso en la consola del navegador
                    Console.WriteLine("¡Llegó notificación de SignalR!");
                    OnInboxChanged();
                   // await InvokeAsync(StateHasChanged);
                });

                await hubConnection.StartAsync();
                Console.WriteLine("SignalR conectado exitosamente.");

                // 🔴 PASO CLAVE: Unirse al grupo.
                // Aquí debes pasar el ID de tu instancia (ej. "ChapultepecEvo")
                // Si lo tienes dinámico en el usuario, úsalo. Si no, por ahora hardcode para probar:
                await hubConnection.InvokeAsync("JoinGroup", "ChapultepecEvo");

                Console.WriteLine("SignalR conectado y unido al grupo.");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error conectando a SignalR: {ex.Message}");
            }
        }
    }

    // Debounce para evitar recargas masivas
    CancellationTokenSource? _debounceCts;
    bool _reloading;

    private async void OnInboxChanged()
    {
        // Usamos InvokeAsync porque este evento viene de un hilo externo (SignalR)
        await InvokeAsync(async () =>
        {
            _debounceCts?.Cancel();
            _debounceCts = new CancellationTokenSource();

            try
            {
                await Task.Delay(300, _debounceCts.Token); // Un pequeño delay para esperar a que la DB termine de escribir
            }
            catch (TaskCanceledException) { return; }

            if (_reloading) return;
            _reloading = true;

            try
            {
                // 1. Recargar la lista de hilos (La columna de la izquierda)
                // Esto actualizará los previews y los contadores de no leídos
                Threads = await Inbox.GetThreadsAsync(Selected, SearchText);

                // 2. Si el chat que tenemos abierto es el que recibió el mensaje, lo refrescamos
                if (SelectedThreadId != null)
                {
                    var updatedThread = await Inbox.GetThreadAsync(SelectedThreadId);
                    if (updatedThread != null)
                    {
                        SelectedThread = updatedThread;

                        // 3. Si lo estamos viendo, lo marcamos como leído en la DB
                        if (_mobileShowChat || SelectedThreadId == updatedThread.ThreadId)
                        {
                            await Inbox.MarkReadAsync(SelectedThreadId);
                            SelectedThread.UnreadCount = 0;
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error recargando datos: {ex.Message}");
            }
            finally
            {
                _reloading = false;
                StateHasChanged(); // Forzar a Blazor a re-renderizar la UI
            }
        });
    }

    public async ValueTask DisposeAsync()
    {
        // Desuscribir evento C#
        Inbox.Changed -= OnInboxChanged;

        // Desconectar SignalR
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    private async Task LoadThreadsAsync()
    {
        _loading = true; StateHasChanged();
        try
        {           
            Threads = await Inbox.GetThreadsAsync(Selected, SearchText);

            // Si la lista de la izquierda está vacía (contador 0)
            if (Threads == null || !Threads.Any())
            {
                SelectedThreadId = null;
                SelectedThread = null; // Asegura que el panel derecho se limpie
            }
            else
            {
                // Si el hilo que estaba seleccionado ya no existe en el nuevo filtro
                if (SelectedThreadId == null || !Threads.Any(t => t.ThreadId == SelectedThreadId))
                {
                    // Opcional: Auto-seleccionar el primero o dejar vacío
                    // SelectedThreadId = Threads.First().ThreadId;
                    // SelectedThread = await Inbox.GetThreadAsync(SelectedThreadId);

                    // Recomendado: Limpiar si el hilo actual no pertenece al nuevo filtro
                    SelectedThreadId = null;
                    SelectedThread = null;
                }
            }
        }
        finally
        {
            _loading = false; StateHasChanged();
        }
    }

    private async Task ChangeFilter(InboxFilter f)
    {
        Selected = f;
        SelectedThreadId = null;
        SelectedThread = null; //Limpia el objeto para cerrar el chat actual
        _mobileShowChat = false;
        await LoadThreadsAsync();
    }

    private async Task SelectThread(string id)
    {
        _loadingChat = true;
        StateHasChanged();

        try
        {
            SelectedThreadId = id;
            SelectedThread = await Inbox.GetThreadAsync(id);
            _mobileShowChat = true;

            if (SelectedThread != null && SelectedThread.UnreadCount > 0)
            {
                await Inbox.MarkReadAsync(id);
                SelectedThread.UnreadCount = 0;
            }
        }
        finally
        {
            _loadingChat = false;
            StateHasChanged();
        }
    }

    private async Task SearchChanged(string text)
    {
        SearchText = string.IsNullOrWhiteSpace(text) ? null : text;
        SelectedThreadId = null;
        SelectedThread = null; // Limpia el chat al buscar
        _mobileShowChat = false;
        await LoadThreadsAsync();
    }

    private Task NewConversation() => Task.CompletedTask;

    private async Task AssignToMe()
    {
        if (SelectedThread is null) return;

        await Inbox.AssignAsync(SelectedThread.ThreadId, CurrentUser);

        // Refresco local rápido
        SelectedThread.AssignedTo = CurrentUser;
        var item = Threads.FirstOrDefault(x => x.ThreadId == SelectedThread.ThreadId);
        if (item != null) item.AssignedTo = CurrentUser;

        StateHasChanged();
    }

    private async Task SendMessage(string text)
    {
        if (SelectedThread is null || string.IsNullOrWhiteSpace(text)) return;

        // ✅ USAMOS EL MÉTODO NUEVO SIMPLIFICADO DEL REPOSITORIO
        await Inbox.AppendAgentMessageAsync(SelectedThread.ThreadId, text, CurrentUser);

        // Recargamos el hilo para ver el mensaje enviado inmediatamente
        SelectedThread = await Inbox.GetThreadAsync(SelectedThread.ThreadId);
        StateHasChanged();
    }

    private Task BackToList()
    {
        _mobileShowChat = false;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task HandleContactUpdated(ChatView.ContactChangedArgs e)
    {
        if (SelectedThread != null && SelectedThread.ThreadId == e.ThreadId)
        {
            SelectedThread.CustomerDisplayName = e.Name;
            SelectedThread.CustomerPhone = e.Phone;
            SelectedThread.CustomerEmail = e.Email;
            SelectedThread.CompanyId = e.Company;
        }

        var item = Threads.FirstOrDefault(t => t.ThreadId == e.ThreadId);
        if (item != null)
        {
            item.CustomerDisplayName = e.Name;
            item.CustomerPhone = e.Phone;
            item.CustomerEmail = e.Email;
            item.CompanyId = e.Company;
        }

        StateHasChanged();
        return Task.CompletedTask;
    }
}